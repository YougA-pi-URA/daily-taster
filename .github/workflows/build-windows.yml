name: Build Windows EXE & Android APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_note:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆçœç•¥å¯ï¼‰'
        required: false
        default: 'æœ€æ–°ãƒ“ãƒ«ãƒ‰'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Desktop
    runs-on: windows-latest
    # runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Flutter version info
        run: |
          flutter --version
          dart --version

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows release
        run: flutter build windows --release

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build output directory ==="
          if (Test-Path "build\windows") {
            Get-ChildItem -Recurse "build\windows" -Filter "*.exe" | Select-Object FullName, Length
          } else {
            Write-Host "build\windows not found"
          }

      - name: Zip build artifacts
        shell: pwsh
        run: |
          $buildDir = "build\windows\x64\runner\Release"
          if (-not (Test-Path $buildDir)) {
            Write-Error "Build dir not found: $buildDir"
            exit 1
          }
          Write-Host "Build dir: $buildDir"
          Get-ChildItem $buildDir | Select-Object Name, Length
          $zipName = "DailyTasker-Windows.zip"
          Compress-Archive -Path "$buildDir\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName ($(((Get-Item $zipName).Length / 1MB).ToString('F1')) MB)"

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          if ($content -match 'version:\s+(\S+)') {
            $ver = $matches[1] -replace '\+.*', ''
            echo "version=$ver" >> $env:GITHUB_OUTPUT
            Write-Host "Version: $ver"
          } else {
            echo "version=1.0.0" >> $env:GITHUB_OUTPUT
            Write-Host "Version: 1.0.0 (fallback)"
          }
          
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: DailyTasker-Windows.zip
          retention-days: 1
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Rename APK
        run: cp build/app/outputs/flutter-apk/app-release.apk DailyTasker-Android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: DailyTasker-Android.apk
          retention-days: 1

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-android]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-build

      - name: Get version
        id: version
        run: |
          VER=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | sed 's/+.*//' | tr -d ' ')
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "Version: $VER"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ github.run_number }}"
          name: "Daily Tasker v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})"
          body: |
            ## Daily Tasker v${{ steps.version.outputs.version }}

            ### Windowsç‰ˆ
            1. `DailyTasker-Windows.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ZIPã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ **ã€Œã™ã¹ã¦å±•é–‹ã€**
            3. `daily_tasker.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•
            - Windows 10 / 11ï¼ˆ64bitï¼‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦

            ### Androidç‰ˆ
            1. `DailyTasker-Android.apk` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§é–‹ã„ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            - â€»ã€Œæä¾›å…ƒä¸æ˜ã®ã‚¢ãƒ—ãƒªã€ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

            ### ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
            ${{ github.event.inputs.release_note || 'æœ€æ–°ã®å¤‰æ›´ã‚’åæ˜ ã—ãŸãƒ“ãƒ«ãƒ‰ã§ã™ã€‚' }}

            ---
            ğŸ”¨ Built by GitHub Actions (Run #${{ github.run_number }})
          files: |
            DailyTasker-Windows.zip
            DailyTasker-Android.apk
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # - name: Notify on Mac
      #   if: always() # æˆåŠŸã—ã¦ã‚‚å¤±æ•—ã—ã¦ã‚‚å®Ÿè¡Œ
      #   run: |
      #     osascript -e 'display notification "ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼" with title "GitHub Actions" sound name "Glass"'

