name: Build Windows EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_note:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆçœç•¥å¯ï¼‰'
        required: false
        default: 'æœ€æ–°ãƒ“ãƒ«ãƒ‰'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Desktop
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze (warnings only)
        run: flutter analyze --no-fatal-warnings || true

      - name: Build Windows release
        run: flutter build windows --release

      - name: Zip build artifacts
        shell: pwsh
        run: |
          $buildDir = "build\windows\x64\runner\Release"
          $zipName  = "DailyTasker-Windows.zip"
          Compress-Archive -Path "$buildDir\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"
          Get-Item $zipName | Select-Object Name, Length

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $ver = (Select-String -Path pubspec.yaml -Pattern '^version:\s+(.+)').Matches[0].Groups[1].Value.Trim()
          $buildNum = $ver -replace '\+.*', ''
          echo "version=$buildNum" >> $env:GITHUB_OUTPUT
          echo "Version: $buildNum"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}-build${{ github.run_number }}"
          name: "Daily Tasker v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})"
          body: |
            ## Daily Tasker Windowsç‰ˆ

            ### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•
            1. ä¸‹ã® `DailyTasker-Windows.zip` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ZIPã‚’å±•é–‹ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ â†’ ã™ã¹ã¦å±•é–‹ï¼‰
            3. `daily_tasker.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•

            ### å‹•ä½œç’°å¢ƒ
            - Windows 10 / 11ï¼ˆ64bitï¼‰
            - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€å±•é–‹ã—ã¦ã™ãä½¿ãˆã¾ã™

            ### ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
            ${{ github.event.inputs.release_note || 'æœ€æ–°ã®å¤‰æ›´ã‚’åæ˜ ã—ãŸãƒ“ãƒ«ãƒ‰ã§ã™ã€‚' }}

            ---
            ğŸ”¨ Built automatically by GitHub Actions
          files: DailyTasker-Windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
