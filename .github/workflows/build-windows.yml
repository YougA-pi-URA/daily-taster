name: Build Windows EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_note:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆçœç•¥å¯ï¼‰'
        required: false
        default: 'æœ€æ–°ãƒ“ãƒ«ãƒ‰'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Desktop
    # runs-on: windows-latest
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.x'
          channel: 'stable'
          cache: true

      - name: Flutter version info
        run: |
          flutter --version
          dart --version

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows release
        run: flutter build windows --release

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "=== Build output directory ==="
          if (Test-Path "build\windows") {
            Get-ChildItem -Recurse "build\windows" -Filter "*.exe" | Select-Object FullName, Length
          } else {
            Write-Host "build\windows not found"
          }

      - name: Zip build artifacts
        shell: pwsh
        run: |
          $exePath = Get-ChildItem -Recurse "build\windows" -Filter "*.exe" | Select-Object -First 1
          if ($null -eq $exePath) {
            Write-Error "EXE not found in build\windows"
            exit 1
          }
          $buildDir = $exePath.DirectoryName
          Write-Host "Build dir: $buildDir"
          $zipName = "DailyTasker-Windows.zip"
          Compress-Archive -Path "$buildDir\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName ($(((Get-Item $zipName).Length / 1MB).ToString('F1')) MB)"

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          if ($content -match 'version:\s+(\S+)') {
            $ver = $matches[1] -replace '\+.*', ''
            echo "version=$ver" >> $env:GITHUB_OUTPUT
            Write-Host "Version: $ver"
          } else {
            echo "version=1.0.0" >> $env:GITHUB_OUTPUT
            Write-Host "Version: 1.0.0 (fallback)"
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ github.run_number }}"
          name: "Daily Tasker v${{ steps.version.outputs.version }} (Build ${{ github.run_number }})"
          body: |
            ## Daily Tasker Windowsç‰ˆ

            ### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•
            1. ä¸‹ã® `DailyTasker-Windows.zip` ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ZIPã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ **ã€Œã™ã¹ã¦å±•é–‹ã€**
            3. `daily_tasker.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦èµ·å‹•

            ### å‹•ä½œç’°å¢ƒ
            - Windows 10 / 11ï¼ˆ64bitï¼‰
            - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ãƒ»å±•é–‹ã—ã¦ã™ãä½¿ãˆã¾ã™

            ### ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
            ${{ github.event.inputs.release_note || 'æœ€æ–°ã®å¤‰æ›´ã‚’åæ˜ ã—ãŸãƒ“ãƒ«ãƒ‰ã§ã™ã€‚' }}

            ---
            ğŸ”¨ Built by GitHub Actions (Run #${{ github.run_number }})
          files: DailyTasker-Windows.zip
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
